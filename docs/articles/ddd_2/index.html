<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><script async="" src="https://www.googletagmanager.com/gtag/js?id=undefined"></script><meta name="theme-color" content="#1C1C1C" data-next-head=""/><title data-next-head="">DDDについて（2） | kojikoji&#x27;s blog</title><meta name="description" content="1\. ValueObject について 1.1 基本的な定義 識別子を持たない 例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。 そのため、id: String のような一意な識別子フィールドは基本的に不要です。 不変性..." data-next-head=""/><meta property="og:type" content="website" data-next-head=""/><meta property="og:title" content="DDDについて（2）" data-next-head=""/><meta property="og:description" content="1\. ValueObject について 1.1 基本的な定義 識別子を持たない 例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。 そのため、id: String のような一意な識別子フィールドは基本的に不要です。 不変性..." data-next-head=""/><meta property="og:site_name" content="kojikoji&#x27;s blog" data-next-head=""/><meta property="twitter:card" content="summary" data-next-head=""/><meta property="twitter:creator" content="@yk_amarly_20" data-next-head=""/><meta property="twitter:title" content="DDDについて（2）" data-next-head=""/><meta property="twitter:description" content="1\. ValueObject について 1.1 基本的な定義 識別子を持たない 例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。 そのため、id: String のような一意な識別子フィールドは基本的に不要です。 不変性..." data-next-head=""/><link rel="preload" href="./_next/static/css/44a2062dc950ae87.css" as="style"/><link rel="preload" href="./_next/static/css/f6a33fefd9847fc5.css" as="style"/><script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'undefined', {
            page_path: window.location.pathname,
          });
        </script><link rel="stylesheet" href="./_next/static/css/44a2062dc950ae87.css" data-n-g=""/><link rel="stylesheet" href="./_next/static/css/f6a33fefd9847fc5.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="./_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="./_next/static/chunks/webpack-502a0195d0ce5784.js" defer=""></script><script src="./_next/static/chunks/framework-7ac395d5428c2f9b.js" defer=""></script><script src="./_next/static/chunks/main-0c8d90819880ff59.js" defer=""></script><script src="./_next/static/chunks/pages/_app-41dd936253aa7d92.js" defer=""></script><script src="./_next/static/chunks/5db7a30b-cc577b4ecf42a1d4.js" defer=""></script><script src="./_next/static/chunks/150-a06d12d528e0a215.js" defer=""></script><script src="./_next/static/chunks/394-769f9ec58698b5fe.js" defer=""></script><script src="./_next/static/chunks/pages/articles/%5Bslug%5D-ede425f4c0caac0b.js" defer=""></script><script src="./_next/static/rplhgBE1mZ56YTxuQBmho/_buildManifest.js" defer=""></script><script src="./_next/static/rplhgBE1mZ56YTxuQBmho/_ssgManifest.js" defer=""></script></head><body><link rel="preload" as="image" href="/MyBlog/Images/logo.png"/><link rel="preload" as="image" href="/MyBlog/Images/Yuto.jpg"/><div id="__next"><div class="Layout_root__YiWQr"><div class="Layout_mainContent__FnV3k"><header class="Header_header__b6rsY"><div class="AppContainer_container__HEFL4 Header_container__O36kb"><a href="/"><img class="Header_logo__h1sXA" src="/MyBlog/Images/logo.png" alt="logo"/></a></div></header><div class="Layout_main__65zHd"><div class="AppContainer_container__HEFL4"><div class="ContentsLayout_layout__SN3HZ"><div class="ContentsLayout_contents__9eBSO"><div class="ArticleHeader_root__mjwJx"><h1 class="ArticleHeader_title__Yh6Ag">DDDについて（2）</h1><div class="TagsWithIcon_root__OKGsm"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="hashtag" class="svg-inline--fa fa-hashtag fa-w-14 TagsWithIcon_icon__Czn2P" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 0 0-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 0 0-11.813 9.891L132.528 128H53.432a12 12 0 0 0-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 0 0-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0 0 11.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0 0 11.813-9.891L315.472 384h79.096a12 12 0 0 0 11.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0 0 11.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"></path></svg><p class="TagsWithIcon_tags__6LSfV"><a class="TagsWithIcon_tag__mBuq5" href="/tags/DDD/">DDD</a><span>, </span><a class="TagsWithIcon_tag__mBuq5" href="/tags/Kotlin/">Kotlin</a></p></div><div class="Date_root__IZtIX"><svg aria-hidden="true" focusable="false" data-prefix="far" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 Date_icon__P__n1" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg><time dateTime="2021-10-12T0001:54.325Z" class="Date_datetime__4voxM">2021/10/12 09:01</time></div></div><article class="Article_article__2v2gr"><div class="MarkdownRenderer_markdownBody__8mQRT"><h2 id="1-valueobject-について">1. ValueObject について</h2><h3 id="11-基本的な定義">1.1 基本的な定義</h3><ul><li><p>識別子を持たない</p><ul><li><p>例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。</p></li><li><p>そのため、id: String のような一意な識別子フィールドは基本的に不要です。</p></li></ul></li><li><p>不変性（Immutability）</p><ul><li><p>一度生成したら内部状態が変化しない。</p></li><li><p>データ破壊的なメソッド（setter や var での再代入）は原則として避け、必要とあれば「新しいインスタンスを返す」メソッドを用意する。</p></li></ul></li><li><p>同値性（Equals / HashCode）</p><ul><li><p>属性（フィールド）の値がすべて同じ場合、equals() も hashCode() も等しくなるよう実装する。(kotlin の場合)</p></li><li><p>Kotlin の data class を使えば、自動的に属性すべてを比較してくれるため、VO には最適。</p></li></ul></li><li><p>ドメインルール・バリデーションを持つ</p><ul><li><p>EmailAddress や PhoneNumber のように「文字列としての形式チェック」「範囲チェック」など、値に関するドメイン固有の制約を constructor（または factory）で実施する。</p></li><li><p>エラー時は IllegalArgumentException などを投げて、「不正な値オブジェクトはそもそも生成できない」ようにする。</p></li></ul></li></ul><h2 id="2-kotlin-を活かした-vo-の基本パターン">2. Kotlin を活かした VO の基本パターン</h2><h3 id="21-kotlin-の-data-class-を使う">2.1 Kotlin の data class を使う</h3><p>もっともシンプルに実装できるのが、data class による定義です。以下は「住所(Address)」を VO 化した例です。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">Address</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> street</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> city</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> postalCode</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> country</span><span class="token" style="color:#00e0e0">:</span><span> String
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">init</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>street</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNotBlank</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Street は空にできません。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>city</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNotBlank</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;City は空にできません。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>postalCode</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">matches</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">Regex</span><span class="token" style="color:#fefefe">(</span><span class="token string-literal singleline" style="color:#abe338">&quot;\\d{3}-\\d{4}&quot;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;PostalCode は XXX-XXXX の形式である必要があります。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>country</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNotBlank</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Country は空にできません。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></pre><p>以上のコードでは、 <code>Address</code> という VO を作成したものになります。
<code>Address</code> は <code>street</code>, <code>city</code>, <code>postalCode</code>, <code>country</code> という住所に関する情報を持っていて、それぞれに関する入力ルールも保持しています。
この定義でも問題ないのですが、弊チームでのコーディングルールでは生の型は基本的に使わず、上の例の <code>street</code> などもすべて VO にするということにしています。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">Address</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> street</span><span class="token" style="color:#00e0e0">:</span><span> Street</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> city</span><span class="token" style="color:#00e0e0">:</span><span> City</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> postalCode</span><span class="token" style="color:#00e0e0">:</span><span> PostalCode</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> country</span><span class="token" style="color:#00e0e0">:</span><span> Country
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">..</span><span class="token" style="color:#fefefe">.</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">Street</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> value</span><span class="token" style="color:#00e0e0">:</span><span> String
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">init</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNotBlank</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Street は空にできません。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab">// その他のVOも同様</span></code></pre><p>このようにするメリットは、他の VO や Entity で <code>Street</code> を使い回す際にルールを再度定義する必要がないという点です。何度も同じルールを複数箇所で書くと、ルールの書き間違いなどが起こりやすく脆弱な状態です。それを阻止するために VO を作り、そこにルールを持たせるようにするというのは明確な利点です。
デメリットは書くのがめんどい（我慢せい）。</p><h2 id="3-発展的な-vo-パターンとベストプラクティス">3. 発展的な VO パターンとベストプラクティス</h2><h3 id="31-再利用可能なバリデーションロジックの共有">3.1 再利用可能なバリデーションロジックの共有</h3><p>複数の VO で同じバリデーションロジック（電話番号の正規表現やメールアドレスの形式チェックなど）を使いたい場合、共通クラス・ユーティリティにまとめることで重複を避けられます。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">object</span><span> ValidationUtils </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">private</span><span> </span><span class="token" style="color:#00e0e0">val</span><span> EMAIL_REGEX </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">Regex</span><span class="token" style="color:#fefefe">(</span><span class="token string-literal singleline" style="color:#abe338">&quot;^[\\w\\.\\-]+@[\\w\\.\\-]+\\.[a-zA-Z]{2,}\$&quot;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">private</span><span> </span><span class="token" style="color:#00e0e0">val</span><span> PHONE_REGEX </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">Regex</span><span class="token" style="color:#fefefe">(</span><span class="token string-literal singleline" style="color:#abe338">&quot;\\+\\d{1,3}-\\d{7,15}&quot;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">private</span><span> </span><span class="token" style="color:#00e0e0">val</span><span> POSTAL_CODE_REGEX </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">Regex</span><span class="token" style="color:#fefefe">(</span><span class="token string-literal singleline" style="color:#abe338">&quot;\\d{3}-\\d{4}&quot;</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">validateEmail</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">matches</span><span class="token" style="color:#fefefe">(</span><span>EMAIL_REGEX</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;メールアドレスの形式が不正です: </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">value</span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">validatePhone</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">matches</span><span class="token" style="color:#fefefe">(</span><span>PHONE_REGEX</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;電話番号の形式が不正です: </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">value</span><span class="token string-literal singleline" style="color:#abe338"> (例: +81-9012345678)&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">validatePostalCode</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">matches</span><span class="token" style="color:#fefefe">(</span><span>POSTAL_CODE_REGEX</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;郵便番号の形式が不正です: </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">value</span><span class="token string-literal singleline" style="color:#abe338"> (例: 123-4567)&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></pre><p>ただこれはこれでこの object が肥大化しますし、個人的には各 VO に持たせるのが良さそうに思います。
どうしても共通化したい場合は、util クラスを validation ごとに作成し、各 VO ではそのクラスを継承させるのが良さそうです。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">Email</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    value</span><span class="token" style="color:#00e0e0">:</span><span> String
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">init</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">validateEmail</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">validateEmail</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">matches</span><span class="token" style="color:#fefefe">(</span><span>EMAIL_REGEX</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;メールアドレスの形式が不正です: </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">value</span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab">// 各Emailを実装する際にこのクラスを継承させる</span><span>
</span><span></span><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">UserEmail</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#ffd700">Email</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">)</span></code></pre><h3 id="32-factory-パターンで複雑な-vo-を生成する">3.2 Factory パターンで複雑な VO を生成する</h3><p>VO がディレクトリ形式の String や複数の入力を受け取りつつ、生成ロジックが複雑になる場合は、専用の Factory オブジェクト を用意すると責務が明確になります。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">object</span><span> AddressFactory </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">/**
</span><span class="token" style="color:#d4d0ab">     * 日本向け住所を生成（都道府県・市区町村・番地・建物名 の入力を受け取る例）
</span><span class="token" style="color:#d4d0ab">     */</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">createJapaneseAddress</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>        prefecture</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        city</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        block</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        building</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#00e0e0">?</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">null</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> Address </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">val</span><span> street </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">prefecture</span><span class="token string-literal singleline" style="color:#abe338"> </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">city</span><span class="token string-literal singleline" style="color:#abe338"> </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">block</span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">val</span><span> fullStreet </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>building</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNullOrBlank</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> street </span><span class="token" style="color:#00e0e0">else</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">street</span><span class="token string-literal singleline" style="color:#abe338"> </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">building</span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">Address</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>            street </span><span class="token" style="color:#00e0e0">=</span><span> fullStreet</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            city </span><span class="token" style="color:#00e0e0">=</span><span> city</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            postalCode </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span class="token string-literal singleline interpolation interpolation-punctuation">${</span><span class="token string-literal singleline interpolation expression">prefecture</span><span class="token string-literal singleline interpolation expression">.</span><span class="token string-literal singleline interpolation expression">take</span><span class="token string-literal singleline interpolation expression">(</span><span class="token string-literal singleline interpolation expression">2</span><span class="token string-literal singleline interpolation expression">)</span><span class="token string-literal singleline interpolation interpolation-punctuation">}</span><span class="token string-literal singleline" style="color:#abe338">-</span><span class="token string-literal singleline interpolation interpolation-punctuation">${</span><span class="token string-literal singleline interpolation expression">city</span><span class="token string-literal singleline interpolation expression">.</span><span class="token string-literal singleline interpolation expression">take</span><span class="token string-literal singleline interpolation expression">(</span><span class="token string-literal singleline interpolation expression">3</span><span class="token string-literal singleline interpolation expression">)</span><span class="token string-literal singleline interpolation interpolation-punctuation">}</span><span class="token string-literal singleline" style="color:#abe338">-0000&quot;</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#d4d0ab">// 仮の郵便番号ロジック</span><span>
</span><span>            country </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Japan&quot;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d0ab">/**
</span><span class="token" style="color:#d4d0ab">     * US 向け住所を生成（番地・通り名・州・郵便番号 の入力を受け取る例）
</span><span class="token" style="color:#d4d0ab">     */</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">createUSAddress</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>        streetNumber</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        streetName</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        state</span><span class="token" style="color:#00e0e0">:</span><span> String</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        zipCode</span><span class="token" style="color:#00e0e0">:</span><span> String
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> Address </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">val</span><span> street </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">streetNumber</span><span class="token string-literal singleline" style="color:#abe338"> </span><span class="token string-literal singleline interpolation interpolation-punctuation">$</span><span class="token string-literal singleline interpolation expression">streetName</span><span class="token string-literal singleline" style="color:#abe338">&quot;</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">Address</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>            street </span><span class="token" style="color:#00e0e0">=</span><span> street</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            city </span><span class="token" style="color:#00e0e0">=</span><span> state</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            postalCode </span><span class="token" style="color:#00e0e0">=</span><span> zipCode</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            country </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;USA&quot;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab">// 使用例</span><span>
</span><span></span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">main</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> tokyoAddress </span><span class="token" style="color:#00e0e0">=</span><span> AddressFactory</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">createJapaneseAddress</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>        prefecture </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Tokyo-to&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        city </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Chiyoda-ku&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        block </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;1-1-1&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        building </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;皇居&quot;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">println</span><span class="token" style="color:#fefefe">(</span><span>tokyoAddress</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab">// Address(street=Tokyo-to Chiyoda-ku 1-1-1 皇居, city=Chiyoda-ku, postalCode=To-Ch-0000, country=Japan)</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">val</span><span> nyAddress </span><span class="token" style="color:#00e0e0">=</span><span> AddressFactory</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">createUSAddress</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>        streetNumber </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;1600&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        streetName </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Pennsylvania Ave NW&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        state </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;Washington DC&quot;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        zipCode </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;20500&quot;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">println</span><span class="token" style="color:#fefefe">(</span><span>nyAddress</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab">// Address(street=1600 Pennsylvania Ave NW, city=Washington DC, postalCode=20500, country=USA)</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></pre><h3 id="33-配列リストマップをフィールドに持つ-vo">3.3 配列・リスト・マップをフィールドに持つ VO</h3><p>VO 内に List や Set、Map などのコレクションをフィールドとして持つ場合、mutable なコレクション参照を外部にさらすと不変性が崩れる可能性があります。以下のように対策します。</p><pre style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-kotlin" style="white-space:pre;color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">Tag</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> name</span><span class="token" style="color:#00e0e0">:</span><span> String
</span><span></span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">data</span><span> </span><span class="token" style="color:#00e0e0">class</span><span> </span><span class="token" style="color:#ffd700">TagList</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">private</span><span> </span><span class="token" style="color:#00e0e0">val</span><span> _tags</span><span class="token" style="color:#00e0e0">:</span><span> List</span><span class="token" style="color:#00e0e0">&lt;</span><span>Tag</span><span class="token" style="color:#00e0e0">&gt;</span><span>  </span><span class="token" style="color:#d4d0ab">// private にして外部参照を隠蔽</span><span>
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">val</span><span> tags</span><span class="token" style="color:#00e0e0">:</span><span> List</span><span class="token" style="color:#00e0e0">&lt;</span><span>Tag</span><span class="token" style="color:#00e0e0">&gt;</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">get</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> _tags</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">toList</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>    </span><span class="token" style="color:#d4d0ab">// 毎回コピーを返して不変性を確保</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">init</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>_tags</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">isNotEmpty</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;タグは 1 つ以上必要です。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>_tags</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">map</span><span> </span><span class="token" style="color:#fefefe">{</span><span> it</span><span class="token" style="color:#fefefe">.</span><span>name </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">distinct</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>size </span><span class="token" style="color:#00e0e0">==</span><span> _tags</span><span class="token" style="color:#fefefe">.</span><span>size</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            </span><span class="token string-literal singleline" style="color:#abe338">&quot;同じタグ名は含められません。&quot;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d0ab">// タグを追加した新しい TagList を返す</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">fun</span><span> </span><span class="token" style="color:#ffd700">addTag</span><span class="token" style="color:#fefefe">(</span><span>newTag</span><span class="token" style="color:#00e0e0">:</span><span> Tag</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> TagList </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">require</span><span class="token" style="color:#fefefe">(</span><span>_tags</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#ffd700">none</span><span> </span><span class="token" style="color:#fefefe">{</span><span> it</span><span class="token" style="color:#fefefe">.</span><span>name </span><span class="token" style="color:#00e0e0">==</span><span> newTag</span><span class="token" style="color:#fefefe">.</span><span>name </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> </span><span class="token string-literal singleline" style="color:#abe338">&quot;同じタグは既に存在します。&quot;</span><span> </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">TagList</span><span class="token" style="color:#fefefe">(</span><span>_tags </span><span class="token" style="color:#00e0e0">+</span><span> newTag</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span></code></pre><h2 id="4-アンチパターンと注意点">4 アンチパターンと注意点</h2><h3 id="41-大きすぎる-value-object-バケツ-vo-の警戒">4.1 大きすぎる Value Object (バケツ VO) の警戒</h3><p>すべてのフィールドを単一の大きな VO にまとめると、</p><ul><li>テストが難しくなる</li><li>バリデーションエラー時の責務が曖昧になる</li><li>読みやすさ・可読性が低下する</li><li>エンティティに埋め込んだときのパフォーマンスに影響が出る</li></ul><p>という問題が起こり得ます。
「責務が一つの VO が小さく、シンプルである」 という原則を守り、必要に応じて複数の VO に分割しましょう。</p><h3 id="42-可変コレクションを公開しない">4.2 可変コレクションを公開しない</h3><p>VO 内で var tags: MutableList<span><String></span> のように mutable なコレクションを公開してしまうと、不変性が崩れてしまいます。</p><p>必ず private なコレクションを使い、外部には不変コレクション（List, Set）を返す か、防御的コピーを行いましょう（前述の TagList 参照）。</p><h3 id="43-equalshashcode-の整合性を保つ">4.3 equals/hashCode の整合性を保つ</h3><p>equals() と hashCode() は、常に「属性すべて」の値を比較するように実装 しなければ、VO の同一性判断が崩れます。</p><p>data class を使う場合は自動生成されますが、明示的に equals/hashCode をカスタマイズしたい場合は、細心の注意を持って実装してください。</p><h3 id="終わりに">終わりに</h3><p>今回は VO についてあれこれ書きました。
次回は Entity について書いていこうかと思います。</p></div></article><div class="Article_articleFooter__IDKpe"><a class="Article_githubLink__Iwmhn" href="https://github.com/yk-amarly-20" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 Article_githubIcon__E8D4X" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> 質問、修正リクエストはGitHubまで</a></div></div><div class="ContentsLayout_sidemenuContainer__uHw0a"><div class="ContentsLayout_sidemenu__jckjS"><div class="ContentsLayout_aboutme__LDJfw"><div><div class="SideMenuTitle_root__lGDHp"><div class="SideMenuTitle_icon__9JKgj"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="leaf" class="svg-inline--fa fa-leaf fa-w-18 AboutMe_icon__plH03" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M546.2 9.7c-5.6-12.5-21.6-13-28.3-1.2C486.9 62.4 431.4 96 368 96h-80C182 96 96 182 96 288c0 7 .8 13.7 1.5 20.5C161.3 262.8 253.4 224 384 224c8.8 0 16 7.2 16 16s-7.2 16-16 16C132.6 256 26 410.1 2.4 468c-6.6 16.3 1.2 34.9 17.5 41.6 16.4 6.8 35-1.1 41.8-17.3 1.5-3.6 20.9-47.9 71.9-90.6 32.4 43.9 94 85.8 174.9 77.2C465.5 467.5 576 326.7 576 154.3c0-50.2-10.8-102.2-29.8-144.6z"></path></svg></div><div class="SideMenuTitle_children__gpH_2">About Me</div></div><div class="AboutMe_wrapper__OTjD3"><div class="AboutMe_aboutme__tpvWO"><img src="/MyBlog/Images/Yuto.jpg" class="AboutMe_avatar___ys0V" alt="avatar"/><div class="AboutMe_biography__EUP2X"><p>コジコジ</p><p>ソフトウェアエンジニア</p><p><a href="https://github.com/yk-amarly-20" target="_blank" rel="noopener noreferrer">Github <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16 AboutMe_linkIcon__fQ78R" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path></svg></a></p><p><a href="https://twitter.com/yk_Amarly_20" target="_blank" rel="noopener noreferrer">Twitter <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16 AboutMe_linkIcon__fQ78R" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path></svg></a></p><p><a href="https://yk-amarly-20.github.io/portfolio/" target="_blank" rel="noopener noreferrer">Portfolio <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16 AboutMe_linkIcon__fQ78R" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path></svg></a></p></div></div></div></div></div><div class="ContentsLayout_otherMenu__ZtAIx"><div><div class="Toc_title__CKNc4"><div class="SideMenuTitle_root__lGDHp"><div class="SideMenuTitle_icon__9JKgj"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="list" class="svg-inline--fa fa-list fa-w-16 Toc_icon__uFqMe" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M80 368H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm0-320H16A16 16 0 0 0 0 64v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16V64a16 16 0 0 0-16-16zm0 160H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm416 176H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z"></path></svg></div><div class="SideMenuTitle_children__gpH_2">Table of Contents</div></div></div><div class="Toc_toc__mgO90"><ul class="Toc_list__N0nA7"><li><a href="#1-valueobject-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" node="[object Object]" class="Toc_link__mcopT">1. ValueObject について</a><ul class="Toc_list__N0nA7"><li><a href="#11-%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E5%AE%9A%E7%BE%A9" node="[object Object]" class="Toc_link__mcopT">1.1 基本的な定義</a></li></ul></li><li><a href="#2-kotlin-%E3%82%92%E6%B4%BB%E3%81%8B%E3%81%97%E3%81%9F-vo-%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3" node="[object Object]" class="Toc_link__mcopT">2. Kotlin を活かした VO の基本パターン</a><ul class="Toc_list__N0nA7"><li><a href="#21-kotlin-%E3%81%AE-data-class-%E3%82%92%E4%BD%BF%E3%81%86" node="[object Object]" class="Toc_link__mcopT">2.1 Kotlin の data class を使う</a></li></ul></li><li><a href="#3-%E7%99%BA%E5%B1%95%E7%9A%84%E3%81%AA-vo-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9" node="[object Object]" class="Toc_link__mcopT">3. 発展的な VO パターンとベストプラクティス</a><ul class="Toc_list__N0nA7"><li><a href="#31-%E5%86%8D%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%AE%E5%85%B1%E6%9C%89" node="[object Object]" class="Toc_link__mcopT">3.1 再利用可能なバリデーションロジックの共有</a></li><li><a href="#32-factory-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A7%E8%A4%87%E9%9B%91%E3%81%AA-vo-%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B" node="[object Object]" class="Toc_link__mcopT">3.2 Factory パターンで複雑な VO を生成する</a></li><li><a href="#33-%E9%85%8D%E5%88%97%E3%83%BB%E3%83%AA%E3%82%B9%E3%83%88%E3%83%BB%E3%83%9E%E3%83%83%E3%83%97%E3%82%92%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E6%8C%81%E3%81%A4-vo" node="[object Object]" class="Toc_link__mcopT">3.3 配列・リスト・マップをフィールドに持つ VO</a></li></ul></li><li><a href="#4-%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E6%B3%A8%E6%84%8F%E7%82%B9" node="[object Object]" class="Toc_link__mcopT">4 アンチパターンと注意点</a><ul class="Toc_list__N0nA7"><li><a href="#41-%E5%A4%A7%E3%81%8D%E3%81%99%E3%81%8E%E3%82%8B-value-object-%E3%83%90%E3%82%B1%E3%83%84-vo-%E3%81%AE%E8%AD%A6%E6%88%92" node="[object Object]" class="Toc_link__mcopT">4.1 大きすぎる Value Object (バケツ VO) の警戒</a></li><li><a href="#42-%E5%8F%AF%E5%A4%89%E3%82%B3%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%85%AC%E9%96%8B%E3%81%97%E3%81%AA%E3%81%84" node="[object Object]" class="Toc_link__mcopT">4.2 可変コレクションを公開しない</a></li><li><a href="#43-equalshashcode-%E3%81%AE%E6%95%B4%E5%90%88%E6%80%A7%E3%82%92%E4%BF%9D%E3%81%A4" node="[object Object]" class="Toc_link__mcopT">4.3 equals/hashCode の整合性を保つ</a></li><li><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB" node="[object Object]" class="Toc_link__mcopT">終わりに</a></li></ul></li></ul></div></div></div></div></div><button class="ContentsLayout_sidemenuOpenButton__TYei4"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars fa-w-14 ContentsLayout_menuIcon__WgoMS" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"></path></svg></button></div></div></div><footer class="Footer_footer__JrJN9"><div class="AppContainer_container__HEFL4"><p class="Footer_text__JQL1U">This site uses<!-- --> <a href="https://policies.google.com/technologies/partner-sites?hl=ja" target="_blank" rel="noopener noreferrer">Google Analytics <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16 Footer_icon__Tbatf" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path></svg></a></p><p class="Footer_text__JQL1U">© <!-- --> <a href="https://twitter.com/yk_amarly_20" target="_blank" rel="noopener noreferrer">kojikoji <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16 Footer_icon__Tbatf" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path></svg></a></p></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"header":{"slug":"ddd_2","matter":{"title":"DDDについて（2）","createdAt":"2021-10-12T0001:54.325Z","tags":["DDD","Kotlin"]},"excerpt":"1\\. ValueObject について 1.1 基本的な定義 識別子を持たない 例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。 そのため、id: String のような一意な識別子フィールドは基本的に不要です。 不変性..."},"bodyMdText":"\n## 1. ValueObject について\n\n### 1.1 基本的な定義\n\n- 識別子を持たない\n\n  - 例えば「住所(Address)」や「金額(Money)」といったドメイン概念の場合、同じ属性の組み合わせであれば同一の値オブジェクトとみなせます。\n\n  - そのため、id: String のような一意な識別子フィールドは基本的に不要です。\n\n- 不変性（Immutability）\n\n  - 一度生成したら内部状態が変化しない。\n\n  - データ破壊的なメソッド（setter や var での再代入）は原則として避け、必要とあれば「新しいインスタンスを返す」メソッドを用意する。\n\n- 同値性（Equals / HashCode）\n\n  - 属性（フィールド）の値がすべて同じ場合、equals() も hashCode() も等しくなるよう実装する。(kotlin の場合)\n\n  - Kotlin の data class を使えば、自動的に属性すべてを比較してくれるため、VO には最適。\n\n- ドメインルール・バリデーションを持つ\n\n  - EmailAddress や PhoneNumber のように「文字列としての形式チェック」「範囲チェック」など、値に関するドメイン固有の制約を constructor（または factory）で実施する。\n\n  - エラー時は IllegalArgumentException などを投げて、「不正な値オブジェクトはそもそも生成できない」ようにする。\n\n## 2. Kotlin を活かした VO の基本パターン\n\n### 2.1 Kotlin の data class を使う\n\nもっともシンプルに実装できるのが、data class による定義です。以下は「住所(Address)」を VO 化した例です。\n\n```kotlin\ndata class Address(\n    val street: String,\n    val city: String,\n    val postalCode: String,\n    val country: String\n) {\n    init {\n        require(street.isNotBlank()) { \"Street は空にできません。\" }\n        require(city.isNotBlank()) { \"City は空にできません。\" }\n        require(postalCode.matches(Regex(\"\\\\d{3}-\\\\d{4}\"))) { \"PostalCode は XXX-XXXX の形式である必要があります。\" }\n        require(country.isNotBlank()) { \"Country は空にできません。\" }\n    }\n}\n```\n\n以上のコードでは、 `Address` という VO を作成したものになります。\n`Address` は `street`, `city`, `postalCode`, `country` という住所に関する情報を持っていて、それぞれに関する入力ルールも保持しています。\nこの定義でも問題ないのですが、弊チームでのコーディングルールでは生の型は基本的に使わず、上の例の `street` などもすべて VO にするということにしています。\n\n```kotlin\ndata class Address(\n    val street: Street,\n    val city: City,\n    val postalCode: PostalCode,\n    val country: Country\n) {\n    ...\n}\n\ndata class Street(\n    val value: String\n) {\n    init {\n        require(value.isNotBlank()){ \"Street は空にできません。\" }\n    }\n}\n\n// その他のVOも同様\n```\n\nこのようにするメリットは、他の VO や Entity で `Street` を使い回す際にルールを再度定義する必要がないという点です。何度も同じルールを複数箇所で書くと、ルールの書き間違いなどが起こりやすく脆弱な状態です。それを阻止するために VO を作り、そこにルールを持たせるようにするというのは明確な利点です。\nデメリットは書くのがめんどい（我慢せい）。\n\n## 3. 発展的な VO パターンとベストプラクティス\n\n### 3.1 再利用可能なバリデーションロジックの共有\n\n複数の VO で同じバリデーションロジック（電話番号の正規表現やメールアドレスの形式チェックなど）を使いたい場合、共通クラス・ユーティリティにまとめることで重複を避けられます。\n\n```kotlin\nobject ValidationUtils {\n    private val EMAIL_REGEX = Regex(\"^[\\\\w\\\\.\\\\-]+@[\\\\w\\\\.\\\\-]+\\\\.[a-zA-Z]{2,}\\$\")\n    private val PHONE_REGEX = Regex(\"\\\\+\\\\d{1,3}-\\\\d{7,15}\")\n    private val POSTAL_CODE_REGEX = Regex(\"\\\\d{3}-\\\\d{4}\")\n\n    fun validateEmail(value: String) {\n        require(value.matches(EMAIL_REGEX)) { \"メールアドレスの形式が不正です: $value\" }\n    }\n\n    fun validatePhone(value: String) {\n        require(value.matches(PHONE_REGEX)) { \"電話番号の形式が不正です: $value (例: +81-9012345678)\" }\n    }\n\n    fun validatePostalCode(value: String) {\n        require(value.matches(POSTAL_CODE_REGEX)) { \"郵便番号の形式が不正です: $value (例: 123-4567)\" }\n    }\n}\n```\n\nただこれはこれでこの object が肥大化しますし、個人的には各 VO に持たせるのが良さそうに思います。\nどうしても共通化したい場合は、util クラスを validation ごとに作成し、各 VO ではそのクラスを継承させるのが良さそうです。\n\n```kotlin\ndata class Email(\n    value: String\n) {\n    init {\n        validateEmail(value)\n    }\n    fun validateEmail(value: String) {\n        require(value.matches(EMAIL_REGEX)) { \"メールアドレスの形式が不正です: $value\" }\n    }\n}\n\n// 各Emailを実装する際にこのクラスを継承させる\ndata class UserEmail(value: String): Email(value)\n```\n\n### 3.2 Factory パターンで複雑な VO を生成する\n\nVO がディレクトリ形式の String や複数の入力を受け取りつつ、生成ロジックが複雑になる場合は、専用の Factory オブジェクト を用意すると責務が明確になります。\n\n```kotlin\nobject AddressFactory {\n    /**\n     * 日本向け住所を生成（都道府県・市区町村・番地・建物名 の入力を受け取る例）\n     */\n    fun createJapaneseAddress(\n        prefecture: String,\n        city: String,\n        block: String,\n        building: String? = null\n    ): Address {\n        val street = \"$prefecture $city $block\"\n        val fullStreet = if (building.isNullOrBlank()) street else \"$street $building\"\n        return Address(\n            street = fullStreet,\n            city = city,\n            postalCode = \"${prefecture.take(2)}-${city.take(3)}-0000\", // 仮の郵便番号ロジック\n            country = \"Japan\"\n        )\n    }\n\n    /**\n     * US 向け住所を生成（番地・通り名・州・郵便番号 の入力を受け取る例）\n     */\n    fun createUSAddress(\n        streetNumber: String,\n        streetName: String,\n        state: String,\n        zipCode: String\n    ): Address {\n        val street = \"$streetNumber $streetName\"\n        return Address(\n            street = street,\n            city = state,\n            postalCode = zipCode,\n            country = \"USA\"\n        )\n    }\n}\n\n// 使用例\nfun main() {\n    val tokyoAddress = AddressFactory.createJapaneseAddress(\n        prefecture = \"Tokyo-to\",\n        city = \"Chiyoda-ku\",\n        block = \"1-1-1\",\n        building = \"皇居\"\n    )\n    println(tokyoAddress)  // Address(street=Tokyo-to Chiyoda-ku 1-1-1 皇居, city=Chiyoda-ku, postalCode=To-Ch-0000, country=Japan)\n\n    val nyAddress = AddressFactory.createUSAddress(\n        streetNumber = \"1600\",\n        streetName = \"Pennsylvania Ave NW\",\n        state = \"Washington DC\",\n        zipCode = \"20500\"\n    )\n    println(nyAddress)  // Address(street=1600 Pennsylvania Ave NW, city=Washington DC, postalCode=20500, country=USA)\n}\n```\n\n### 3.3 配列・リスト・マップをフィールドに持つ VO\n\nVO 内に List や Set、Map などのコレクションをフィールドとして持つ場合、mutable なコレクション参照を外部にさらすと不変性が崩れる可能性があります。以下のように対策します。\n\n```kotlin\ndata class Tag(\n    val name: String\n)\n\ndata class TagList(\n    private val _tags: List\u003cTag\u003e  // private にして外部参照を隠蔽\n) {\n    val tags: List\u003cTag\u003e\n        get() = _tags.toList()    // 毎回コピーを返して不変性を確保\n\n    init {\n        require(_tags.isNotEmpty()) { \"タグは 1 つ以上必要です。\" }\n        require(_tags.map { it.name }.distinct().size == _tags.size) {\n            \"同じタグ名は含められません。\"\n        }\n    }\n\n    // タグを追加した新しい TagList を返す\n    fun addTag(newTag: Tag): TagList {\n        require(_tags.none { it.name == newTag.name }) { \"同じタグは既に存在します。\" }\n        return TagList(_tags + newTag)\n    }\n}\n\n```\n\n## 4 アンチパターンと注意点\n\n### 4.1 大きすぎる Value Object (バケツ VO) の警戒\n\nすべてのフィールドを単一の大きな VO にまとめると、\n\n- テストが難しくなる\n- バリデーションエラー時の責務が曖昧になる\n- 読みやすさ・可読性が低下する\n- エンティティに埋め込んだときのパフォーマンスに影響が出る\n\nという問題が起こり得ます。\n「責務が一つの VO が小さく、シンプルである」 という原則を守り、必要に応じて複数の VO に分割しましょう。\n\n### 4.2 可変コレクションを公開しない\n\nVO 内で var tags: MutableList\u003cString\u003e のように mutable なコレクションを公開してしまうと、不変性が崩れてしまいます。\n\n必ず private なコレクションを使い、外部には不変コレクション（List, Set）を返す か、防御的コピーを行いましょう（前述の TagList 参照）。\n\n### 4.3 equals/hashCode の整合性を保つ\n\nequals() と hashCode() は、常に「属性すべて」の値を比較するように実装 しなければ、VO の同一性判断が崩れます。\n\ndata class を使う場合は自動生成されますが、明示的に equals/hashCode をカスタマイズしたい場合は、細心の注意を持って実装してください。\n\n### 終わりに\n\n今回は VO についてあれこれ書きました。\n次回は Entity について書いていこうかと思います。\n","tocMdText":"- [1. ValueObject について](#1-valueobject-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)\n  * [1.1 基本的な定義](#11-%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E5%AE%9A%E7%BE%A9)\n- [2. Kotlin を活かした VO の基本パターン](#2-kotlin-%E3%82%92%E6%B4%BB%E3%81%8B%E3%81%97%E3%81%9F-vo-%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3)\n  * [2.1 Kotlin の data class を使う](#21-kotlin-%E3%81%AE-data-class-%E3%82%92%E4%BD%BF%E3%81%86)\n- [3. 発展的な VO パターンとベストプラクティス](#3-%E7%99%BA%E5%B1%95%E7%9A%84%E3%81%AA-vo-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9)\n  * [3.1 再利用可能なバリデーションロジックの共有](#31-%E5%86%8D%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%81%AE%E5%85%B1%E6%9C%89)\n  * [3.2 Factory パターンで複雑な VO を生成する](#32-factory-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A7%E8%A4%87%E9%9B%91%E3%81%AA-vo-%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B)\n  * [3.3 配列・リスト・マップをフィールドに持つ VO](#33-%E9%85%8D%E5%88%97%E3%83%BB%E3%83%AA%E3%82%B9%E3%83%88%E3%83%BB%E3%83%9E%E3%83%83%E3%83%97%E3%82%92%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E6%8C%81%E3%81%A4-vo)\n- [4 アンチパターンと注意点](#4-%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E6%B3%A8%E6%84%8F%E7%82%B9)\n  * [4.1 大きすぎる Value Object (バケツ VO) の警戒](#41-%E5%A4%A7%E3%81%8D%E3%81%99%E3%81%8E%E3%82%8B-value-object-%E3%83%90%E3%82%B1%E3%83%84-vo-%E3%81%AE%E8%AD%A6%E6%88%92)\n  * [4.2 可変コレクションを公開しない](#42-%E5%8F%AF%E5%A4%89%E3%82%B3%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%85%AC%E9%96%8B%E3%81%97%E3%81%AA%E3%81%84)\n  * [4.3 equals/hashCode の整合性を保つ](#43-equalshashcode-%E3%81%AE%E6%95%B4%E5%90%88%E6%80%A7%E3%82%92%E4%BF%9D%E3%81%A4)\n  * [終わりに](#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB)"}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"ddd_2"},"buildId":"rplhgBE1mZ56YTxuQBmho","assetPrefix":".","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>